# MQTT Broker - 3-Node Cluster: Node 1
# Bootstrap node for a 3-node cluster
# Run all three nodes simultaneously to form the cluster

server:
  tcp:
    plain:
      addr: ":1883"
      max_connections: 10000
      read_timeout: "60s"
      write_timeout: "60s"
    tls: {}
    mtls: {}

  websocket:
    plain:
      addr: ""  # Disabled for cluster testing
    tls:
      addr: ""
    mtls:
      addr: ""

  http:
    plain:
      addr: ""  # Disabled for cluster testing
    tls:
      addr: ""
    mtls:
      addr: ""

  coap:
    plain:
      addr: ""  # Disabled for cluster testing
    dtls:
      addr: ""
    mdtls:
      addr: ""

  amqp:
    plain:
      addr: ":5672"
    tls: {}
    mtls: {}

  amqp091:
    plain:
      addr: ":5682"
    tls: {}
    mtls: {}

  health_enabled: true
  health_addr: ":8081"

  shutdown_timeout: "30s"

broker:
  max_message_size: 1048576
  max_retained_messages: 10000
  retry_interval: "20s"
  max_retries: 0

session:
  max_sessions: 1000000
  default_expiry_interval: 300
  max_offline_queue_size: 1000
  max_inflight_messages: 1000

storage:
  type: "badger"
  badger_dir: "/tmp/fluxmq/node1/data"

cluster:
  enabled: true
  node_id: "node1"

  etcd:
    data_dir: "/tmp/fluxmq/node1/etcd"
    bind_addr: "127.0.0.1:2380"
    client_addr: "127.0.0.1:2379"
    initial_cluster: "node1=http://127.0.0.1:2380,node2=http://127.0.0.1:2480,node3=http://127.0.0.1:2580"
    bootstrap: true  # First node bootstraps the cluster

  transport:
    bind_addr: "127.0.0.1:7948"
    peers:
      node2: "127.0.0.1:7949"
      node3: "127.0.0.1:7950"

  raft:
    enabled: true
    auto_provision_groups: true
    replication_factor: 3
    sync_mode: true
    min_in_sync_replicas: 2
    ack_timeout: "5s"
    write_policy: "forward"
    distribution_mode: "replicate"
    bind_addr: "127.0.0.1:7100"
    data_dir: "/tmp/fluxmq/node1/raft"
    peers:
      node2: "127.0.0.1:7200"
      node3: "127.0.0.1:7300"
    heartbeat_timeout: "1s"
    election_timeout: "3s"
    snapshot_interval: "5m"
    snapshot_threshold: 8192
    groups:
      hot:
        bind_addr: "127.0.0.1:8100"
        data_dir: "/tmp/fluxmq/node1/raft-hot"
        peers:
          node2: "127.0.0.1:8200"
          node3: "127.0.0.1:8300"
        replication_factor: 3
        min_in_sync_replicas: 2
        ack_timeout: "5s"

log:
  level: "debug"
  format: "text"

queue_manager:
  auto_commit_interval: 5s

queues:
  - name: "mqtt"
    topics:
      - "$queue/#"
    reserved: true
    replication:
      enabled: true
      group: "default"             # uses the base raft group
      replication_factor: 3
      mode: "sync"
      min_in_sync_replicas: 2
      ack_timeout: "5s"
  - name: "hot-events"
    topics:
      - "$queue/hot-events/#"
    replication:
      enabled: true
      group: "hot"                 # uses the statically-configured "hot" group above
      replication_factor: 3
      mode: "sync"
      min_in_sync_replicas: 2
      ack_timeout: "5s"
  # This queue references a group not listed under cluster.raft.groups.
  # Because auto_provision_groups is true, the broker will dynamically
  # create a dedicated Raft group with ports derived from the base bind_addr.
  - name: "audit-log"
    topics:
      - "$queue/audit/#"
    replication:
      enabled: true
      group: "audit"               # auto-provisioned at startup
      replication_factor: 3
      mode: "async"
      min_in_sync_replicas: 1
      ack_timeout: "10s"
