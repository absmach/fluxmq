---
import { render, type CollectionEntry } from "astro:content";
import { Docs } from "@/components/docs";
import defaultMdxComponents from "fumadocs-ui/mdx";
import { source } from "@/lib/source";
import Layout from "@/components/layout.astro";
import type { TOCItemType } from "fumadocs-core/toc";
import Mermaid from "../../components/mdx/Mermaid.astro";

interface Props {
  page: CollectionEntry<"docs">;
}

export async function getStaticPaths() {
  const pages = source.getPages();
  const paths = pages.map((page) => ({
    params: { slug: page.slugs.length > 0 ? page.slugs.join("/") : undefined },
    props: { page: page.data._raw },
  }));

  // Alias the root docs page to `/docs/index` to avoid edge-case 404s in some dev/preview setups.
  const rootPage = pages.find((page) => page.slugs.length === 0);
  if (rootPage) {
    paths.push({
      params: { slug: "index" },
      props: { page: rootPage.data._raw },
    });
  }

  return paths;
}

const { page } = Astro.props;
const { Content, headings } = await render(page);

const toc: TOCItemType[] = headings.map((heading) => ({
  depth: heading.depth,
  title: heading.text,
  url: `#${heading.slug}`,
}));
---

<Layout>
  <title>{page.data.title}</title>
  <meta name="title" content={page.data.title} />
  <meta name="description" content={page.data.description} />
  <Docs
    tree={source.getPageTree()}
    pathname={Astro.url.pathname}
    params={Astro.params as Record<string, string | string[]>}
    page={{ toc }}
    title={page.data.title}
    description={page.data.description}
    client:load
  >
    <Content components={{ ...defaultMdxComponents, Mermaid }} />
  </Docs>
</Layout>
