---
import '../styles/global.css';
import { ClientRouter } from 'astro:transitions';
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <ClientRouter />
    <script is:inline>
      (() => {
        const THEME_KEY = 'theme';
        const DARK_QUERY = '(prefers-color-scheme: dark)';

        const resolveStoredTheme = () => {
          try {
            const stored = localStorage.getItem(THEME_KEY);
            const mode =
              stored === 'light' || stored === 'dark' || stored === 'system'
                ? stored
                : 'system';
            if (mode === 'system') {
              return window.matchMedia(DARK_QUERY).matches ? 'dark' : 'light';
            }
            return mode;
          } catch {
            return window.matchMedia(DARK_QUERY).matches ? 'dark' : 'light';
          }
        };

        const readActiveTheme = () => {
          const root = document.documentElement;
          if (root.classList.contains('dark') || root.dataset.theme === 'dark') {
            return 'dark';
          }
          if (root.classList.contains('light') || root.dataset.theme === 'light') {
            return 'light';
          }
          return resolveStoredTheme();
        };

        const applyTheme = (doc, resolved) => {
          const root = doc.documentElement;
          root.classList.remove('light', 'dark');
          root.classList.add(resolved);
          root.classList.toggle('dark', resolved === 'dark');
          root.dataset.theme = resolved;
          root.style.colorScheme = resolved;
        };

        const syncCurrentDocument = () => {
          applyTheme(document, resolveStoredTheme());
        };

        const syncIncomingDocument = (event) => {
          if (!event?.newDocument) return;
          applyTheme(event.newDocument, readActiveTheme());
        };

        // Apply immediately for first paint.
        syncCurrentDocument();

        // Keep incoming pages on the same theme during Astro transitions.
        document.addEventListener('astro:before-preparation', syncIncomingDocument);
        document.addEventListener('astro:before-swap', syncIncomingDocument);

        // Re-assert theme after swap/page lifecycle in case another script mutates it.
        document.addEventListener('astro:after-swap', syncCurrentDocument);
        document.addEventListener('astro:page-load', syncCurrentDocument);
      })();
    </script>
  </head>
  <body
    class="bg-theme text-[var(--flux-text)] flex min-h-screen flex-col"
    transition:persist
    transition:animate="none"
    transition:name="page-layout"
  >
    <slot />
  </body>
</html>
